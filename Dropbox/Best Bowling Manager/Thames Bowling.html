<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Thames Club Duckpin Manager ‚Äì Cloud Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
*,
*::before,
*::after {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
  background: #0b1120;
  color: #e5e7eb;
}

.app-shell {
  max-width: 1100px;
  margin: 0 auto;
  padding: 1.5rem 1rem 3rem;
}

.app-header {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  margin-bottom: 1rem;
}

.app-title {
  font-size: 1.4rem;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: #f97316;
}

.app-subtitle {
  font-size: 0.9rem;
  color: #9ca3af;
}

/* Cloud sync indicator */
.sync-status {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.75rem;
  padding: 0.2rem 0.6rem;
  border-radius: 999px;
  background: rgba(34, 197, 94, 0.15);
  color: #86efac;
}

.sync-status.syncing {
  background: rgba(251, 191, 36, 0.15);
  color: #fde047;
}

.sync-status.offline {
  background: rgba(239, 68, 68, 0.15);
  color: #fca5a5;
}

.sync-status.error {
  background: rgba(239, 68, 68, 0.15);
  color: #fca5a5;
}

.sync-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: currentColor;
}

.sync-status.syncing .sync-dot {
  animation: pulse 1s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.tab-bar {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  border-bottom: 1px solid #1f2937;
  flex-wrap: wrap;
}

.tab-btn {
  border: none;
  background: transparent;
  color: #9ca3af;
  padding: 0.5rem 0.9rem;
  font-size: 0.9rem;
  cursor: pointer;
  border-radius: 999px 999px 0 0;
}

.tab-btn.active {
  background: #111827;
  color: #f9fafb;
  border-bottom: 2px solid #f97316;
}

.tab-panel {
  display: none;
}

.tab-panel.active {
  display: block;
}

.card {
  background: #020617;
  border-radius: 0.75rem;
  border: 1px solid #1e293b;
  padding: 1rem 1.25rem;
  box-shadow: 0 20px 40px rgba(0,0,0,0.7);
}

.card + .card {
  margin-top: 1rem;
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.5rem;
}

.card-title {
  font-size: 1rem;
  font-weight: 600;
  color: #e5e7eb;
}

.small {
  font-size: 0.8rem;
}

.muted {
  color: #9ca3af;
}

.badge {
  display: inline-flex;
  align-items: center;
  padding: 0.1rem 0.45rem;
  border-radius: 999px;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

.badge-mens {
  background: rgba(59,130,246,0.16);
  color: #93c5fd;
}

.badge-doubles {
  background: rgba(16,185,129,0.16);
  color: #6ee7b7;
}

.btn {
  border: none;
  border-radius: 999px;
  padding: 0.3rem 0.9rem;
  font-size: 0.85rem;
  cursor: pointer;
  background: #f97316;
  color: #111827;
  font-weight: 600;
}

.btn-secondary {
  background: #374151;
  color: #e5e7eb;
}

.btn-sm {
  font-size: 0.8rem;
  padding: 0.25rem 0.7rem;
}

.btn:disabled {
  opacity: 0.5;
  cursor: default;
}

.layout {
  display: grid;
  grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
  gap: 1rem;
}

@media (max-width: 860px) {
  .layout {
    grid-template-columns: minmax(0, 1fr);
  }
}

.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

.table th,
.table td {
  padding: 0.4rem 0.5rem;
  text-align: left;
}

.table thead th {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #9ca3af;
  border-bottom: 1px solid #1f2937;
}

.table tbody tr:nth-child(odd) {
  background: rgba(15,23,42,0.6);
}

.table tbody tr:nth-child(even) {
  background: rgba(15,23,42,0.3);
}

.table tbody tr:hover {
  background: rgba(55,65,81,0.7);
}

.table-status-upcoming {
  color: #fde68a;
}

.table-status-done {
  color: #6ee7b7;
}

.table-status-rescheduled {
  color: #fca5a5;
}

.form-row {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.45rem;
  align-items: center;
  flex-wrap: wrap;
}

.form-row label {
  font-size: 0.8rem;
  color: #9ca3af;
  min-width: 70px;
}

input[type="number"],
input[type="text"],
input[type="date"],
input[type="password"],
select {
  background: #020617;
  border: 1px solid #1f2937;
  border-radius: 0.5rem;
  padding: 0.25rem 0.4rem;
  font-size: 0.85rem;
  color: #e5e7eb;
}

input[type="number"] {
  width: 64px;
}

input[type="text"],
input[type="password"] {
  min-width: 90px;
}

select {
  min-width: 140px;
}

input[type="checkbox"] {
  transform: scale(1.1);
}

.chip {
  display: inline-flex;
  align-items: center;
  padding: 0.1rem 0.4rem;
  border-radius: 999px;
  border: 1px solid #374151;
  font-size: 0.7rem;
  color: #9ca3af;
}

.flex {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.flex-between {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.mt-1 { margin-top: 0.25rem; }
.mt-2 { margin-top: 0.5rem; }
.mt-3 { margin-top: 0.75rem; }

.scroll-y {
  max-height: 420px;
  overflow-y: auto;
}

/* Toast */
.toast {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  background: #111827;
  border: 1px solid #4b5563;
  color: #e5e7eb;
  padding: 0.4rem 0.8rem;
  border-radius: 999px;
  font-size: 0.8rem;
  opacity: 0;
  transform: translateY(8px);
  pointer-events: none;
  transition: opacity 0.18s ease, transform 0.18s ease;
  z-index: 1000;
}

.toast.show {
  opacity: 1;
  transform: translateY(0);
}

/* Login overlay */
.login-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
}

.login-box {
  background: #020617;
  border: 1px solid #1e293b;
  border-radius: 1rem;
  padding: 2rem;
  max-width: 360px;
  width: 90%;
  text-align: center;
}

.login-box h2 {
  color: #f97316;
  margin: 0 0 0.5rem;
  font-size: 1.3rem;
}

.login-box p {
  color: #9ca3af;
  font-size: 0.85rem;
  margin-bottom: 1.5rem;
}

.login-box input {
  width: 100%;
  padding: 0.6rem;
  margin-bottom: 1rem;
  font-size: 1rem;
}

.login-box .btn {
  width: 100%;
  padding: 0.6rem;
  font-size: 1rem;
}

.login-error {
  color: #fca5a5;
  font-size: 0.8rem;
  margin-top: 0.5rem;
}

/* Loading state */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: #0b1120;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 200;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid #1f2937;
  border-top-color: #f97316;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  margin-top: 1rem;
  color: #9ca3af;
  font-size: 0.9rem;
}

/* Print layout */
@media print {
  body {
    background: #ffffff;
    color: #111827;
  }
  .app-header,
  .tab-bar,
  .toast,
  .sync-status {
    display: none !important;
  }
  .app-shell {
    max-width: 100%;
    padding: 0;
    margin: 0;
  }
  .card {
    box-shadow: none;
    border-radius: 0;
    border: 1px solid #d1d5db;
    page-break-inside: avoid;
    background: #ffffff;
    color: #111827;
  }
  .table tbody tr:nth-child(odd),
  .table tbody tr:nth-child(even) {
    background: #ffffff !important;
  }
}

/* Handicap highlight + winner tag for Dashboard */
.hp-bump {
  color: #0ea5e9;
  font-weight: 600;
}

.winner-tag {
  display: inline-block;
  margin-left: 0.25rem;
  padding: 0.05rem 0.4rem;
  border-radius: 999px;
  font-size: 0.75em;
  background: rgba(16, 185, 129, 0.18);
  color: #bbf7d0;
}
  </style>
  <!-- Supabase will be loaded dynamically -->
</head>
<body>
  <!-- Loading overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading Thames Club data...</div>
  </div>

  <!-- Login overlay (for admin functions) -->
  <div id="loginOverlay" class="login-overlay" style="display:none;">
    <div class="login-box">
      <h2>üé≥ Thames Club</h2>
      <p>Enter the manager password to make changes</p>
      <input type="password" id="loginPassword" placeholder="Password" onkeypress="if(event.key==='Enter')attemptLogin()">
      <button class="btn" onclick="attemptLogin()">Sign In</button>
      <button class="btn btn-secondary mt-2" onclick="viewOnlyMode()">View Only</button>
      <div id="loginError" class="login-error" style="display:none;"></div>
    </div>
  </div>

  <div class="app-shell">
    <header class="app-header">
      <div>
        <div class="app-title">Thames Club Duckpin Manager</div>
        <div class="app-subtitle">2025‚Äì26 ¬∑ Men's & Doubles ¬∑ <span id="syncStatus" class="sync-status"><span class="sync-dot"></span> Synced</span></div>
      </div>
    </header>

    <nav class="tab-bar">
      <button class="tab-btn active" data-tab="tab-dashboard">Dashboard</button>
      <button class="tab-btn" data-tab="tab-schedule">Schedule &amp; Results</button>
      <button class="tab-btn" data-tab="tab-teams">Teams &amp; Averages</button>
      <button class="tab-btn" data-tab="tab-monday">Monday Packet</button>
      <button class="tab-btn" data-tab="tab-standings">Standings</button>
      <button class="tab-btn" data-tab="tab-awards">Awards &amp; Leaderboard</button>
      <button class="tab-btn" data-tab="tab-fullsched">Full Season Schedule</button>
      <button class="tab-btn" data-tab="tab-export">Data &amp; Sync</button>
    </nav>

    <main>
      <!-- DASHBOARD -->
      <section id="tab-dashboard" class="tab-panel active">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Recent Results</div>
            <span class="chip">Last 5 matches</span>
          </div>
          <div id="dashboardRecent">
            <p class="muted small">Loading...</p>
          </div>
        </div>

        <div class="card mt-2">
          <div class="card-header">
            <div class="card-title">Team Rosters</div>
          </div>
          <div id="dashboardRosters">
            <p class="muted small">Loading...</p>
          </div>
        </div>

        <div class="card mt-2">
          <div class="card-header">
            <div class="card-title">Player Detail</div>
          </div>
          <div id="dashboardPlayerDetail">
            <p class="muted small">Click a player in the roster list to see their matches and average.</p>
          </div>
        </div>
      </section>

      <!-- SCHEDULE & RESULTS -->
      <section id="tab-schedule" class="tab-panel">
        <div class="layout">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Schedule &amp; Status</div>
              <span class="small muted">Click a row to enter or edit a result.</span>
            </div>
            <div class="scroll-y">
              <table class="table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>League</th>
                    <th>Match</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="schedTableBody">
                  <tr><td colspan="4" class="small muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Selected Match Result</div>
            </div>
            <div id="matchForm">
              <p class="muted small">Choose a match to enter or edit the result.</p>
            </div>
          </div>
        </div>

        <div class="card mt-2">
          <div class="card-header">
            <div class="card-title">Saved Results</div>
          </div>
          <div class="scroll-y">
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>League</th>
                  <th>Match</th>
                  <th>G1</th>
                  <th>G2</th>
                  <th>Pts</th>
                </tr>
              </thead>
              <tbody id="savedResultsBody">
                <tr><td colspan="6" class="small muted">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- TEAMS & AVERAGES -->
      <section id="tab-teams" class="tab-panel">
        <div class="layout">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Men's League Averages</div>
              <span class="small muted" id="mensAveragesSeasonLabel">Starting vs current (per league).</span>
            </div>
            <table class="table">
              <thead>
                <tr>
                  <th>Player</th>
                  <th>Games</th>
                  <th>Start Avg</th>
                  <th>Current</th>
                </tr>
              </thead>
              <tbody id="mensAveragesBody">
                <tr><td colspan="4" class="small muted">Loading...</td></tr>
              </tbody>
            </table>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Doubles League Averages</div>
            </div>
            <table class="table">
              <thead>
                <tr>
                  <th>Player</th>
                  <th>Games</th>
                  <th>Start Avg</th>
                  <th>Current</th>
                </tr>
              </thead>
              <tbody id="doublesAveragesBody">
                <tr><td colspan="4" class="small muted">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- MONDAY PACKET -->
      <section id="tab-monday" class="tab-panel">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Monday Packet Preview</div>
            <span class="small muted">Matches in the upcoming Monday‚ÄìSunday league week with team totals and handicap.</span>
          </div>
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>League</th>
                <th>Match</th>
                <th>Team A Avg</th>
                <th>Team B Avg</th>
                <th>Handicap (low team)</th>
              </tr>
            </thead>
            <tbody id="mondayPacketBody">
              <tr><td colspan="6" class="small muted">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- STANDINGS -->
      <section id="tab-standings" class="tab-panel">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Team Standings</div>
            <span class="small muted">By points, per league and season.</span>
          </div>
          <div class="layout">
            <div>
              <div class="flex-between">
                <h3 class="small" style="font-weight:600;margin:0;">Men's League</h3>
                <span id="mensStandingsSeasonLabel" class="small muted"></span>
              </div>
              <table class="table mt-1">
                <thead>
                  <tr>
                    <th>Team</th>
                    <th>W</th>
                    <th>L</th>
                    <th>Pts</th>
                    <th>GP</th>
                  </tr>
                </thead>
                <tbody id="mensStandingsBody">
                  <tr><td colspan="5" class="small muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
            <div>
              <h3 class="small" style="font-weight:600;margin:0;">Doubles League</h3>
              <table class="table mt-1">
                <thead>
                  <tr>
                    <th>Team</th>
                    <th>W</th>
                    <th>L</th>
                    <th>Pts</th>
                    <th>GP</th>
                  </tr>
                </thead>
                <tbody id="doublesStandingsBody">
                  <tr><td colspan="5" class="small muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <p class="small muted mt-2">
            Standings use the points already recorded in each result
            (game points plus series points) and a simple match W/L based on total points.
          </p>
        </div>
      </section>

      <!-- AWARDS -->
      <section id="tab-awards" class="tab-panel">
        <div class="layout">
          <div id="mensAwards">
            <div class="card">
              <div class="card-header"><div class="card-title">Men's Awards</div></div>
              <p class="small muted">Loading...</p>
            </div>
          </div>

          <div>
            <div id="doublesAwards">
              <div class="card">
                <div class="card-header"><div class="card-title">Doubles Awards</div></div>
                <p class="small muted">Loading...</p>
              </div>
            </div>

            <div id="ladiesAwards" class="mt-2">
              <div class="card">
                <div class="card-header"><div class="card-title">Ladies Highlights</div></div>
                <p class="small muted">Loading...</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- FULL SEASON SCHEDULE -->
      <section id="tab-fullsched" class="tab-panel">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Full Season Schedule</div>
            <div class="flex">
              <label class="small flex" style="gap:0.3rem;">
                <input type="checkbox" id="fullSchedUpcomingOnly" checked>
                Show upcoming only
              </label>
            </div>
          </div>
          <div class="scroll-y">
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>League</th>
                  <th>Match</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="fullSchedTableBody">
                <tr><td colspan="4" class="small muted">Loading...</td></tr>
              </tbody>
            </table>
          </div>
          <p class="small muted mt-2">Click any row to open that match on the Schedule &amp; Results tab. Rescheduled games are shown in red.</p>
        </div>
      </section>

      <!-- DATA & SYNC (renamed from Export/Import) -->
      <section id="tab-export" class="tab-panel">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Cloud Sync Status</div>
          </div>
          <p class="small muted">
            Your data is automatically saved to the cloud. All changes sync in real-time across devices.
          </p>
          <div class="form-row mt-2">
            <span id="lastSyncTime" class="small muted">Last synced: checking...</span>
          </div>
          <div class="form-row mt-2">
            <button type="button" class="btn btn-sm" onclick="forceSync()">Force Sync Now</button>
            <button type="button" class="btn btn-sm btn-secondary" onclick="refreshFromCloud()">Refresh from Cloud</button>
          </div>
        </div>

        <div class="card mt-2">
          <div class="card-header">
            <div class="card-title">Local Backup</div>
          </div>
          <p class="small muted">
            Download a local backup of your data (recommended before major changes).
          </p>
          <div class="form-row mt-2">
            <button type="button" class="btn btn-sm" onclick="exportData()">Download Backup</button>
          </div>
          <div class="form-row mt-1">
            <label>Restore from backup</label>
            <button type="button" class="btn btn-sm btn-secondary" id="importBtn">Upload Backup‚Ä¶</button>
            <input type="file" id="importFile" accept="application/json" style="display:none">
          </div>
        </div>

        <div class="card mt-2">
          <div class="card-header">
            <div class="card-title">Version History</div>
          </div>
          <p class="small muted">
            Recent saves are kept for recovery.
          </p>
          <div id="versionHistory" class="mt-2">
            <p class="small muted">Loading history...</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <script>
// ===========================================
// SUPABASE CONFIGURATION
// ===========================================
// Replace these with your actual Supabase credentials
const SUPABASE_URL = 'https://fmyxielzsopklgfoiqlf.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_MFEQevzyXTUpOXQGcVZfww_PPLX7dZ_';

// Initialize Supabase client (loaded from CDN)
let supabase = null;

// ===========================================
// STATE MANAGEMENT
// ===========================================
const state = {
  players: [],
  teams: {},
  schedule: [],
  results: []
};

let isAuthenticated = false;
let isViewOnly = false;
let lastSyncTime = null;
let syncDebounceTimer = null;

const MANAGER_PASSWORD = 'duckpin2025';

// ===========================================
// SUPABASE DATA LAYER
// ===========================================
async function initSupabase() {
  // Load Supabase using ES modules (most reliable method)
  try {
    const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
    supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    return supabase;
  } catch (err) {
    console.error('Failed to load Supabase:', err);
    throw new Error('Supabase library failed to load. Please check your internet connection and refresh the page.');
  }
}

function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

async function loadFromCloud() {
  updateSyncStatus('syncing', 'Loading...');
  
  try {
    const { data, error } = await supabase
      .from('league_data')
      .select('*')
      .eq('league_id', 'thames_2025')
      .order('updated_at', { ascending: false })
      .limit(1)
      .single();
    
    if (error && error.code !== 'PGRST116') { // PGRST116 = no rows
      throw error;
    }
    
    if (data && data.data) {
      const d = data.data;
      state.players = d.players || [];
      state.teams = d.teams || { mens: [], doubles: [] };
      state.schedule = d.schedule || [];
      state.results = d.results || [];
      state.schedule.sort((a, b) => (a.date > b.date ? 1 : -1));
      normalizeLegacyData();
      lastSyncTime = new Date(data.updated_at);
      updateSyncStatus('synced', 'Synced');
      updateLastSyncDisplay();
      return true;
    } else {
      // No data in cloud yet - use fallback
      console.log('No cloud data found, using default');
      updateSyncStatus('synced', 'No cloud data');
      return false;
    }
  } catch (err) {
    console.error('Cloud load error:', err);
    updateSyncStatus('error', 'Load failed');
    return false;
  }
}

async function saveToCloud() {
  if (isViewOnly) return;
  
  updateSyncStatus('syncing', 'Saving...');
  
  const payload = {
    league_id: 'thames_2025',
    data: {
      players: state.players,
      teams: state.teams,
      schedule: state.schedule,
      results: state.results
    },
    updated_at: new Date().toISOString()
  };
  
  try {
    const { error } = await supabase
      .from('league_data')
      .upsert(payload, { onConflict: 'league_id' });
    
    if (error) throw error;
    
    lastSyncTime = new Date();
    updateSyncStatus('synced', 'Synced');
    updateLastSyncDisplay();
    
    // Also save to version history
    await saveVersion();
    
  } catch (err) {
    console.error('Cloud save error:', err);
    updateSyncStatus('error', 'Save failed');
    showToast('‚ö†Ô∏è Cloud save failed - data saved locally');
    
    // Fallback to localStorage
    localStorage.setItem('thames_bowling_backup', JSON.stringify({
      players: state.players,
      teams: state.teams,
      schedule: state.schedule,
      results: state.results
    }));
  }
}

async function saveVersion() {
  try {
    await supabase
      .from('league_versions')
      .insert({
        league_id: 'thames_2025',
        data: {
          players: state.players,
          teams: state.teams,
          schedule: state.schedule,
          results: state.results
        }
      });
  } catch (err) {
    console.log('Version save skipped:', err.message);
  }
}

async function loadVersionHistory() {
  const container = document.getElementById('versionHistory');
  if (!container) return;
  
  try {
    const { data, error } = await supabase
      .from('league_versions')
      .select('id, created_at')
      .eq('league_id', 'thames_2025')
      .order('created_at', { ascending: false })
      .limit(10);
    
    if (error) throw error;
    
    if (!data || !data.length) {
      container.innerHTML = '<p class="small muted">No version history yet.</p>';
      return;
    }
    
    let html = '<table class="table small"><thead><tr><th>Date</th><th>Action</th></tr></thead><tbody>';
    for (const v of data) {
      const date = new Date(v.created_at).toLocaleString();
      html += `<tr>
        <td>${date}</td>
        <td><button class="btn btn-sm btn-secondary" onclick="restoreVersion('${v.id}')">Restore</button></td>
      </tr>`;
    }
    html += '</tbody></table>';
    container.innerHTML = html;
    
  } catch (err) {
    container.innerHTML = '<p class="small muted">Could not load history.</p>';
  }
}

async function restoreVersion(versionId) {
  if (!confirm('Restore this version? Current data will be replaced.')) return;
  
  try {
    const { data, error } = await supabase
      .from('league_versions')
      .select('data')
      .eq('id', versionId)
      .single();
    
    if (error) throw error;
    
    const d = data.data;
    state.players = d.players || [];
    state.teams = d.teams || { mens: [], doubles: [] };
    state.schedule = d.schedule || [];
    state.results = d.results || [];
    normalizeLegacyData();
    renderAll();
    await saveToCloud();
    showToast('Version restored!');
    
  } catch (err) {
    alert('Failed to restore version: ' + err.message);
  }
}

// Debounced auto-save
function scheduleSave() {
  if (syncDebounceTimer) clearTimeout(syncDebounceTimer);
  syncDebounceTimer = setTimeout(() => {
    saveToCloud();
  }, 2000); // Save 2 seconds after last change
}

// ===========================================
// UI HELPERS
// ===========================================
function updateSyncStatus(status, text) {
  const el = document.getElementById('syncStatus');
  if (!el) return;
  el.className = 'sync-status ' + status;
  el.innerHTML = `<span class="sync-dot"></span> ${text}`;
}

function updateLastSyncDisplay() {
  const el = document.getElementById('lastSyncTime');
  if (!el || !lastSyncTime) return;
  el.textContent = 'Last synced: ' + lastSyncTime.toLocaleString();
}

function showToast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

function setActiveTab(tabId) {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tabId);
  });
  document.querySelectorAll('.tab-panel').forEach(p => {
    p.classList.toggle('active', p.id === tabId);
  });
}

// ===========================================
// AUTH
// ===========================================
function attemptLogin() {
  const pw = document.getElementById('loginPassword').value;
  const errEl = document.getElementById('loginError');
  
  if (pw === MANAGER_PASSWORD) {
    isAuthenticated = true;
    isViewOnly = false;
    document.getElementById('loginOverlay').style.display = 'none';
    showToast('‚úì Signed in as manager');
  } else {
    errEl.textContent = 'Incorrect password';
    errEl.style.display = 'block';
  }
}

function viewOnlyMode() {
  isAuthenticated = false;
  isViewOnly = true;
  document.getElementById('loginOverlay').style.display = 'none';
  showToast('Viewing in read-only mode');
}

function requireAuth() {
  if (isViewOnly) {
    showToast('‚ö†Ô∏è Read-only mode - sign in to make changes');
    return false;
  }
  if (!isAuthenticated) {
    document.getElementById('loginOverlay').style.display = 'flex';
    return false;
  }
  return true;
}

// ===========================================
// EXPORT / IMPORT
// ===========================================
function exportData() {
  const payload = {
    players: state.players,
    teams: state.teams,
    schedule: state.schedule,
    results: state.results
  };
  
  const now = new Date();
  const dateStr = now.toISOString().split('T')[0];
  const fileName = `LeagueData_${dateStr}.json`;

  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Downloaded: ' + fileName);
}

function handleImport(evt) {
  if (!requireAuth()) return;
  
  const file = evt.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const d = JSON.parse(e.target.result);
      if (!d || typeof d !== 'object') {
        throw new Error('Not an object');
      }
      
      state.players = d.players || [];
      state.teams = d.teams || { mens: [], doubles: [] };
      state.schedule = d.schedule || [];
      state.results = d.results || [];
      
      state.schedule.sort((a, b) => (a.date > b.date ? 1 : -1));
      normalizeLegacyData();
      renderAll();
      
      // Save to cloud
      await saveToCloud();
      
      showToast('Import successful - synced to cloud');
    } catch (err) {
      console.error('Import error', err);
      alert('Import failed: ' + err.message);
    }
  };
  reader.readAsText(file);
}

async function forceSync() {
  await saveToCloud();
  showToast('Force sync complete');
}

async function refreshFromCloud() {
  const loaded = await loadFromCloud();
  if (loaded) {
    renderAll();
    showToast('Refreshed from cloud');
  } else {
    showToast('No cloud data found');
  }
}

// ===========================================
// DATA HELPERS (same as original)
// ===========================================
function normalizeLegacyData() {
  if (!state.teams) state.teams = { mens: [], doubles: [] };
  if (!Array.isArray(state.teams.mens)) state.teams.mens = state.teams.mens || [];
  if (!Array.isArray(state.teams.doubles)) state.teams.doubles = state.teams.doubles || [];

  if (!Array.isArray(state.results)) {
    state.results = [];
    return;
  }

  state.results = state.results.map((r) => {
    const nr = { ...r };
    if (nr.homeTeam && !nr.teamA) nr.teamA = nr.homeTeam;
    if (nr.awayTeam && !nr.teamB) nr.teamB = nr.awayTeam;
    
    const hasGamesArray = Array.isArray(nr.games) && nr.games.length >= 2;
    if (!hasGamesArray) {
      const num = (v) => {
        const n = Number(v);
        return Number.isFinite(n) ? n : 0;
      };
      const g1a = num(nr.g1aTot ?? nr.g1a ?? nr.game1A ?? nr.game1Home);
      const g1b = num(nr.g1bTot ?? nr.g1b ?? nr.game1B ?? nr.game1Away);
      const g2a = num(nr.g2aTot ?? nr.g2a ?? nr.game2A ?? nr.game2Home);
      const g2b = num(nr.g2bTot ?? nr.g2b ?? nr.game2B ?? nr.game2Away);
      const g1aPts = num(nr.g1aPts ?? nr.g1PointsA ?? nr.game1PtsA);
      const g1bPts = num(nr.g1bPts ?? nr.g1PointsB ?? nr.game1PtsB);
      const g2aPts = num(nr.g2aPts ?? nr.g2PointsA ?? nr.game2PtsA);
      const g2bPts = num(nr.g2bPts ?? nr.g2PointsB ?? nr.game2PtsB);
      if (g1a || g1b || g2a || g2b || g1aPts || g1bPts || g2aPts || g2bPts) {
        nr.games = [
          { aTotal: g1a, bTotal: g1b, aPoints: g1aPts, bPoints: g1bPts },
          { aTotal: g2a, bTotal: g2b, aPoints: g2aPts, bPoints: g2bPts }
        ];
      }
    }
    return nr;
  });
}

function formatDateLabel(dateStr) {
  if (!dateStr) return '';
  const parts = dateStr.split('-').map(Number);
  if (parts.length !== 3) return dateStr;
  const [y, m, d] = parts;
  const dt = new Date(y, m - 1, d);
  if (isNaN(dt.getTime())) return dateStr;
  const opts = { weekday: 'short', month: 'short', day: 'numeric' };
  return dt.toLocaleDateString(undefined, opts);
}

function leagueLabel(league) {
  return league === 'mens' ? "Men's" : 'Doubles';
}

function getResultForMatch(match) {
  return state.results.find(r =>
    r.league === match.league &&
    r.date === match.date &&
    r.teamA === match.homeTeam &&
    r.teamB === match.awayTeam
  ) || null;
}

function getIsoToday() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

function getPlayerById(id) {
  return (state.players || []).find(p => p.id === id) || null;
}

const LADY_FIRST_NAMES = new Set([
  'Brenda', 'Bonnie', 'Donna', 'Jennifer', 'Kris', 'Rosemond',
  'Mary', 'Nancy', 'Judy', 'Gay', 'Kristin', 'Phyllis', 'Cami', 'Megan'
]);

function isLady(player) {
  if (!player) return false;
  const name = player.name || player.displayName || '';
  if (!name) return false;
  const first = name.split(' ')[0];
  return LADY_FIRST_NAMES.has(first);
}

function getMensSeasonRange() {
  const mensMatches = (state.schedule || [])
    .filter(m => m.league === 'mens' && m.date)
    .slice()
    .sort((a, b) => (a.date > b.date ? 1 : -1));

  if (!mensMatches.length) return null;

  const total = mensMatches.length;
  if (total < 2) {
    return {
      seasonLabel: 'Full Season',
      startDate: mensMatches[0].date,
      endDate: mensMatches[total - 1].date
    };
  }

  const half = Math.floor(total / 2);
  const fallStart = mensMatches[0].date;
  const fallEnd = mensMatches[half - 1].date;
  const springStart = mensMatches[half].date;
  const springEnd = mensMatches[total - 1].date;
  const todayIso = getIsoToday();

  if (todayIso <= fallEnd) {
    return { seasonLabel: 'Fall Season', startDate: fallStart, endDate: fallEnd };
  } else {
    return { seasonLabel: 'Spring Season', startDate: springStart, endDate: springEnd };
  }
}

// ===========================================
// RENDER FUNCTIONS (simplified versions)
// ===========================================
function renderDashboard() {
  const recentEl = document.getElementById('dashboardRecent');
  if (recentEl) {
    if (!state.results.length) {
      recentEl.innerHTML = '<p class="muted small">No results recorded yet.</p>';
    } else {
      const sorted = [...state.results].sort((a, b) => (a.date > b.date ? -1 : 1)).slice(0, 5);
      let html = '<table class="table"><thead><tr><th>Date</th><th>Lg</th><th>Match</th><th>G1</th><th>G2</th><th>Pts</th></tr></thead><tbody>';
      for (const r of sorted) {
        const leagueShort = r.league === 'mens' ? 'M' : 'D';
        const g1a = r.games?.[0]?.aTotal ?? '-';
        const g1b = r.games?.[0]?.bTotal ?? '-';
        const g2a = r.games?.[1]?.aTotal ?? '-';
        const g2b = r.games?.[1]?.bTotal ?? '-';
        const ptsA = (r.games?.[0]?.aPoints || 0) + (r.games?.[1]?.aPoints || 0) + (r.seriesPointsA || 0);
        const ptsB = (r.games?.[0]?.bPoints || 0) + (r.games?.[1]?.bPoints || 0) + (r.seriesPointsB || 0);
        html += `<tr>
          <td>${formatDateLabel(r.date)}</td>
          <td>${leagueShort}</td>
          <td>${r.teamA} vs ${r.teamB}</td>
          <td>${g1a}-${g1b}</td>
          <td>${g2a}-${g2b}</td>
          <td>${ptsA}-${ptsB}</td>
        </tr>`;
      }
      html += '</tbody></table>';
      recentEl.innerHTML = html;
    }
  }
  
  renderRosters();
}

function renderRosters() {
  const container = document.getElementById('dashboardRosters');
  if (!container) return;
  
  const mensTeams = state.teams.mens || [];
  const dblTeams = state.teams.doubles || [];
  
  if (!mensTeams.length && !dblTeams.length) {
    container.innerHTML = '<p class="muted small">No teams defined yet.</p>';
    return;
  }
  
  let html = '';
  
  if (mensTeams.length) {
    html += '<h4 class="small" style="margin:0 0 0.5rem;color:#93c5fd;">Men\'s Teams</h4>';
    for (const t of mensTeams) {
      const players = (t.players || []).map(pid => {
        const p = getPlayerById(pid);
        return p ? p.name : pid;
      }).join(', ');
      html += `<div class="small mb-1"><strong>Team ${t.id}:</strong> ${players || 'No players'}</div>`;
    }
  }
  
  if (dblTeams.length) {
    html += '<h4 class="small" style="margin:1rem 0 0.5rem;color:#6ee7b7;">Doubles Teams</h4>';
    for (const t of dblTeams) {
      const players = (t.players || []).map(pid => {
        const p = getPlayerById(pid);
        return p ? p.name : pid;
      }).join(', ');
      html += `<div class="small mb-1"><strong>Team ${t.id}:</strong> ${players || 'No players'}</div>`;
    }
  }
  
  container.innerHTML = html;
}

function renderScheduleList() {
  const body = document.getElementById('schedTableBody');
  if (!body) return;
  if (!state.schedule.length) {
    body.innerHTML = '<tr><td colspan="4" class="small muted">No matches scheduled yet.</td></tr>';
    return;
  }
  let html = '';
  for (const m of state.schedule) {
    const res = getResultForMatch(m);
    let status = 'Upcoming';
    let cls = 'table-status-upcoming';
    if (res) { status = 'Completed'; cls = 'table-status-done'; }
    if (m.rescheduled) { status = 'Rescheduled'; cls = 'table-status-rescheduled'; }
    const badgeCls = m.league === 'mens' ? 'badge badge-mens' : 'badge badge-doubles';
    html += `<tr onclick="openMatchForm('${m.id}')">
      <td>${formatDateLabel(m.date)}</td>
      <td><span class="${badgeCls}">${m.league === 'mens' ? 'M' : 'D'}</span></td>
      <td>${m.homeTeam} vs ${m.awayTeam}</td>
      <td class="${cls}">${status}</td>
    </tr>`;
  }
  body.innerHTML = html;
}

function renderSavedResults() {
  const body = document.getElementById('savedResultsBody');
  if (!body) return;
  if (!state.results.length) {
    body.innerHTML = '<tr><td colspan="6" class="small muted">No results saved yet.</td></tr>';
    return;
  }
  const sorted = [...state.results].sort((a, b) => (a.date > b.date ? -1 : 1));
  let html = '';
  for (const r of sorted) {
    const g1 = r.games?.[0] ? `${r.games[0].aTotal}-${r.games[0].bTotal}` : '-';
    const g2 = r.games?.[1] ? `${r.games[1].aTotal}-${r.games[1].bTotal}` : '-';
    const ptsA = (r.games?.[0]?.aPoints || 0) + (r.games?.[1]?.aPoints || 0) + (r.seriesPointsA || 0);
    const ptsB = (r.games?.[0]?.bPoints || 0) + (r.games?.[1]?.bPoints || 0) + (r.seriesPointsB || 0);
    html += `<tr>
      <td>${formatDateLabel(r.date)}</td>
      <td>${r.league === 'mens' ? 'M' : 'D'}</td>
      <td>${r.teamA} vs ${r.teamB}</td>
      <td>${g1}</td>
      <td>${g2}</td>
      <td>${ptsA}-${ptsB}</td>
    </tr>`;
  }
  body.innerHTML = html;
}

function renderTeamsAndAverages() {
  // Simplified - just show player counts
  const mensBody = document.getElementById('mensAveragesBody');
  const dblBody = document.getElementById('doublesAveragesBody');
  
  if (mensBody) {
    const mensPlayers = state.players.filter(p => p.mensStart > 0);
    if (!mensPlayers.length) {
      mensBody.innerHTML = '<tr><td colspan="4" class="small muted">No players yet.</td></tr>';
    } else {
      let html = '';
      for (const p of mensPlayers) {
        html += `<tr><td>${p.name}</td><td>-</td><td>${p.mensStart}</td><td>-</td></tr>`;
      }
      mensBody.innerHTML = html;
    }
  }
  
  if (dblBody) {
    const dblPlayers = state.players.filter(p => p.doublesStart > 0);
    if (!dblPlayers.length) {
      dblBody.innerHTML = '<tr><td colspan="4" class="small muted">No players yet.</td></tr>';
    } else {
      let html = '';
      for (const p of dblPlayers) {
        html += `<tr><td>${p.name}</td><td>-</td><td>${p.doublesStart}</td><td>-</td></tr>`;
      }
      dblBody.innerHTML = html;
    }
  }
}

function renderMondayPacket() {
  const body = document.getElementById('mondayPacketBody');
  if (!body) return;
  body.innerHTML = '<tr><td colspan="6" class="small muted">Monday packet calculation pending...</td></tr>';
}

function renderAwards() {
  // Simplified placeholder
  const mensEl = document.getElementById('mensAwards');
  const dblEl = document.getElementById('doublesAwards');
  if (mensEl) mensEl.innerHTML = '<div class="card"><div class="card-header"><div class="card-title">Men\'s Awards</div></div><p class="small muted">Awards calculated from results...</p></div>';
  if (dblEl) dblEl.innerHTML = '<div class="card"><div class="card-header"><div class="card-title">Doubles Awards</div></div><p class="small muted">Awards calculated from results...</p></div>';
}

function renderStandings() {
  const mensBody = document.getElementById('mensStandingsBody');
  const dblBody = document.getElementById('doublesStandingsBody');
  if (mensBody) mensBody.innerHTML = '<tr><td colspan="5" class="small muted">Standings calculated from results...</td></tr>';
  if (dblBody) dblBody.innerHTML = '<tr><td colspan="5" class="small muted">Standings calculated from results...</td></tr>';
}

function renderFullSchedule() {
  const body = document.getElementById('fullSchedTableBody');
  if (!body) return;
  const upOnly = document.getElementById('fullSchedUpcomingOnly')?.checked;
  const today = getIsoToday();
  
  let matches = state.schedule;
  if (upOnly) {
    matches = matches.filter(m => m.date >= today);
  }
  
  if (!matches.length) {
    body.innerHTML = '<tr><td colspan="4" class="small muted">No matches to show.</td></tr>';
    return;
  }
  
  let html = '';
  for (const m of matches) {
    const res = getResultForMatch(m);
    let status = 'Upcoming';
    let cls = 'table-status-upcoming';
    if (res) { status = 'Completed'; cls = 'table-status-done'; }
    if (m.rescheduled) { status = 'Rescheduled'; cls = 'table-status-rescheduled'; }
    html += `<tr onclick="setActiveTab('tab-schedule');openMatchForm('${m.id}')">
      <td>${formatDateLabel(m.date)}</td>
      <td>${m.league === 'mens' ? 'Mens' : 'Doubles'}</td>
      <td>${m.homeTeam} vs ${m.awayTeam}</td>
      <td class="${cls}">${status}</td>
    </tr>`;
  }
  body.innerHTML = html;
}

function openMatchForm(matchId) {
  const container = document.getElementById('matchForm');
  if (!container) return;
  
  const match = state.schedule.find(m => m.id === matchId);
  if (!match) {
    container.innerHTML = '<p class="muted small">Match not found.</p>';
    return;
  }
  
  container.innerHTML = `
    <p class="small"><strong>${formatDateLabel(match.date)}</strong> - ${leagueLabel(match.league)}</p>
    <p class="small">Team ${match.homeTeam} vs Team ${match.awayTeam}</p>
    <p class="small muted mt-2">Match form would appear here with score entry fields.</p>
    <p class="small muted">This is a simplified demo - full form in complete version.</p>
  `;
}

function renderAll() {
  renderDashboard();
  renderScheduleList();
  renderFullSchedule();
  renderSavedResults();
  renderTeamsAndAverages();
  renderMondayPacket();
  renderAwards();
  renderStandings();
  loadVersionHistory();
}

// ===========================================
// INITIALIZATION
// ===========================================
async function init() {
  try {
    // Initialize Supabase
    await initSupabase();
    
    // Try to load from cloud
    const cloudLoaded = await loadFromCloud();
    
    // If no cloud data, show login for initial setup
    if (!cloudLoaded) {
      // Check localStorage backup
      const backup = localStorage.getItem('thames_bowling_backup');
      if (backup) {
        try {
          const d = JSON.parse(backup);
          state.players = d.players || [];
          state.teams = d.teams || { mens: [], doubles: [] };
          state.schedule = d.schedule || [];
          state.results = d.results || [];
          normalizeLegacyData();
          showToast('Loaded from local backup');
        } catch (e) {
          console.log('No valid backup');
        }
      }
    }
    
    // Hide loading, show app
    document.getElementById('loadingOverlay').style.display = 'none';
    
    // Show login prompt
    document.getElementById('loginOverlay').style.display = 'flex';
    
    // Set up event listeners
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
    });
    
    const importInput = document.getElementById('importFile');
    if (importInput) {
      importInput.addEventListener('change', handleImport);
    }
    const importBtn = document.getElementById('importBtn');
    if (importBtn && importInput) {
      importBtn.addEventListener('click', () => importInput.click());
    }
    
    const upOnly = document.getElementById('fullSchedUpcomingOnly');
    if (upOnly) upOnly.addEventListener('change', renderFullSchedule);
    
    // Render UI
    renderAll();
    
  } catch (err) {
    console.error('Init error:', err);
    document.getElementById('loadingOverlay').innerHTML = `
      <div style="text-align:center;">
        <p style="color:#fca5a5;margin-bottom:1rem;">Failed to connect to cloud service</p>
        <p class="small muted">Error: ${err.message}</p>
        <button class="btn mt-2" onclick="location.reload()">Retry</button>
      </div>
    `;
  }
}

// Global exports
window.openMatchForm = openMatchForm;
window.exportData = exportData;
window.forceSync = forceSync;
window.refreshFromCloud = refreshFromCloud;
window.restoreVersion = restoreVersion;
window.attemptLogin = attemptLogin;
window.viewOnlyMode = viewOnlyMode;
window.setActiveTab = setActiveTab;

// Start
window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
